<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Departments - EquipTrack</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè∑Ô∏è</text></svg>">
    <link rel="stylesheet" href="../../css/superadmin/dashboard.css">
</head>
<body>
    <header class="header" style="position:sticky; top:0; z-index:20;">
        <div class="header-content">
            <div class="logo" style="display:flex; align-items:center; gap:12px;">
                <h1>EquipTrack</h1>
            </div>
            <div class="user-info">
                <div class="welcome"><span id="username">Super Admin</span></div>
                <div class="avatar-wrap">
                    <div id="avatarCircle" class="avatar-circle" title="Profile"></div>
                    <div class="avatar-actions">
                        <button id="avatarOpen" class="icon-btn" title="Upload" aria-label="Upload">üì∑</button>
                        <button id="avatarRemove" class="icon-btn" title="Remove" aria-label="Remove">üóëÔ∏è</button>
                    </div>
                </div>
                <a href="#" class="logout-btn" onclick="logout()">Logout</a>
            </div>
        </div>
    </header>
    <div style="max-width:1400px; margin:0 auto; display:grid; grid-template-columns:260px 1fr; gap:24px; padding:24px;">
        <aside style="background:#fff; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); overflow:auto; position:sticky; top:90px; align-self:start; height:calc(100vh - 110px);">
            <div style="background:#800000; color:#fff; padding:18px 20px; font-weight:600;">Super Admin Panel</div>
            <nav style="padding:14px 10px;">
                <a href="dashboard.html" style="display:flex; align-items:center; gap:10px; padding:12px 12px; color:#333; text-decoration:none; border-radius:8px;">Dashboard</a>
                <a href="add_super_admin.html" style="display:flex; align-items:center; gap:10px; padding:12px 12px; color:#333; text-decoration:none; border-radius:8px;">Manage Super Admins</a>
                <a href="users.html" style="display:flex; align-items:center; gap:10px; padding:12px 12px; color:#333; text-decoration:none; border-radius:8px;">Users</a>
                <a href="departments.html" style="display:flex; align-items:center; gap:10px; padding:12px 12px; color:#800000; text-decoration:none; border-radius:8px; background:#fff3bf;">Departments</a>
                <a href="equipment.html" style="display:flex; align-items:center; gap:10px; padding:12px 12px; color:#333; text-decoration:none; border-radius:8px;">Equipment</a>
                <a href="students.html" style="display:flex; align-items:center; gap:10px; padding:12px 12px; color:#333; text-decoration:none; border-radius:8px;">Students <span style="margin-left:auto; background:#ffd60a; color:#800000; border-radius:999px; padding:2px 8px; font-size:12px; font-weight:700;" id="badgeStudents">0</span></a>
            </nav>
        </aside>
        <main>
            <div class="form-card" id="departmentsCard" style="margin-top:0;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 15px;">
                    <h3 style="color:#800000; margin:0;">Departments</h3>
                    <button id="openAddDept" class="submit-btn" style="background:#ffd60a; color:#800000;">Add Department</button>
                </div>
                <div style="overflow:auto;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="text-align:left; border-bottom:1px solid #eee;">
                                <th style="padding:8px;">Department</th>
                                <th style="padding:8px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deptBody"><tr><td colspan="2" style="padding:10px; color:#666;">Loading‚Ä¶</td></tr></tbody>
                    </table>
                </div>
            </div>
            <!-- Add / Edit Modal -->
            <div id="deptModal" style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center;">
                <div class="form-card" style="width:100%; max-width:460px;">
                    <h3 id="deptModalTitle" style="color:#800000; margin-bottom:12px;">Add Department</h3>
                    <form id="deptForm">
                        <input type="hidden" name="mode" value="add" />
                        <div style="display:grid; gap:12px;">
                            <div>
                                <label>Department name</label>
                                <input type="text" id="deptInput" required>
                            </div>
                            <div class="message" id="deptFormMsg"></div>
                            <div style="display:flex; gap:10px; justify-content:flex-end;">
                                <button type="button" id="cancelDept" class="submit-btn" style="background:#6c757d;">Cancel</button>
                                <button type="submit" class="submit-btn">Save</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
    <!-- Profile Modal -->
    <div id="profileModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Profile Picture</h3>
                <span class="close" onclick="closeProfileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div id="currentProfileDisplay" style="width: 120px; height: 120px; border-radius: 50%; background: #ffd60a; color: #800000; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; margin: 0 auto 15px; background-size: cover; background-position: center;"></div>
                    <p style="color: #666; margin: 0;">Current Profile Picture</p>
                </div>
                <form id="profileForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="profileImage">Upload New Picture</label>
                        <input type="file" id="profileImage" name="profile_image" accept="image/*" style="margin-bottom: 15px;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="cancel-btn" onclick="closeProfileModal()">Cancel</button>
                        <button type="submit" class="submit-btn" style="background: #ffd60a; color: #800000;">Update Profile</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reusable Confirm Modal & Toast Container -->
    <div id="confirmModal" style="position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center;">
        <div class="form-card" style="width:100%; max-width:420px;">
            <h3 id="confirmTitle" style="color:#800000; margin-bottom:10px;">Please Confirm</h3>
            <div id="confirmMessage" style="color:#333;">Are you sure?</div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
                <button type="button" id="confirmCancel" class="submit-btn" style="background:#6c757d;">Cancel</button>
                <button type="button" id="confirmOk" class="submit-btn">OK</button>
            </div>
        </div>
    </div>
    <div id="toastContainer" style="position: fixed; top: 18px; right: 18px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;"></div>
    <script>
        (function(){
            function openConfirm(message, title='Please Confirm'){
                return new Promise(resolve => {
                    const cm = document.getElementById('confirmModal');
                    const msg = document.getElementById('confirmMessage');
                    const ttl = document.getElementById('confirmTitle');
                    const ok = document.getElementById('confirmOk');
                    const cancel = document.getElementById('confirmCancel');
                    ttl.textContent = title; msg.textContent = message;
                    function cleanup(result){ cm.style.display='none'; ok.removeEventListener('click', okH); cancel.removeEventListener('click', cancelH); cm.removeEventListener('click', backdropH); resolve(result); }
                    function okH(){ cleanup(true); } function cancelH(){ cleanup(false); } function backdropH(e){ if(e.target===cm) cleanup(false); }
                    ok.addEventListener('click', okH); cancel.addEventListener('click', cancelH); cm.addEventListener('click', backdropH);
                    cm.style.display='flex';
                });
            }
            function showToast(text){ const c = document.getElementById('toastContainer'); const el = document.createElement('div'); el.style.background='#800000'; el.style.color='#fff'; el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.boxShadow='0 6px 16px rgba(0,0,0,.2)'; el.textContent=text; c.appendChild(el); setTimeout(()=>{ el.remove(); }, 2500); }
            function checkLogin(){
                return fetch('../../php/superadmin/check_session.php').then(r=>r.json()).then(d=>{ if(!d.logged_in){ window.location.href='super_admin_login.html'; } else { document.getElementById('username').textContent = d.username || 'Super Admin'; } });
            }

            // Profile functionality (matching dashboard)
            function loadProfile() {
                console.log('Loading profile...');
                const avatarElement = document.getElementById('avatarCircle');
                if (!avatarElement) {
                    console.error('Avatar element not found, retrying...');
                    setTimeout(loadProfile, 500);
                    return;
                }
                
                fetch('../../php/superadmin/get_profile.php')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Profile data:', data);
                        
                        if (data.success && data.profile_image) {
                            avatarElement.style.backgroundImage = `url('../../uploads/avatars/${data.profile_image}')`;
                            avatarElement.style.backgroundSize = 'cover';
                            avatarElement.style.backgroundPosition = 'center';
                            const currentDisplay = document.getElementById('currentProfileDisplay');
                            if (currentDisplay) {
                                currentDisplay.style.backgroundImage = `url('../../uploads/avatars/${data.profile_image}')`;
                                currentDisplay.style.backgroundSize = 'cover';
                                currentDisplay.style.backgroundPosition = 'center';
                            }
                        } else {
                            const username = data.username || 'Super Admin';
                            const firstLetter = username.charAt(0).toUpperCase();
                            avatarElement.textContent = firstLetter;
                            avatarElement.style.backgroundImage = 'none';
                            const currentDisplay = document.getElementById('currentProfileDisplay');
                            if (currentDisplay) {
                                currentDisplay.textContent = firstLetter;
                                currentDisplay.style.backgroundImage = 'none';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading profile:', error);
                        // Fallback: show first letter of current username
                        const usernameElement = document.getElementById('username');
                        if (usernameElement) {
                            const username = usernameElement.textContent || 'Super Admin';
                            const firstLetter = username.charAt(0).toUpperCase();
                            avatarElement.textContent = firstLetter;
                            avatarElement.style.backgroundImage = 'none';
                        }
                    });
            }

            function openProfileModal() {
                document.getElementById('profileModal').style.display = 'block';
                loadProfile();
            }

            function closeProfileModal() {
                document.getElementById('profileModal').style.display = 'none';
                document.getElementById('profileForm').reset();
            }

            function removeProfile() {
                openConfirm('Remove profile picture?', 'Remove Profile').then(confirmed => {
                    if (!confirmed) return;
                    fetch('../../php/superadmin/remove_profile.php', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showToast('Profile picture removed');
                                loadProfile();
                                closeProfileModal();
                            } else {
                                showToast(data.message || 'Failed to remove profile');
                            }
                        })
                        .catch(() => showToast('Network error'));
                });
            }

            // Profile form submission
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('../../php/superadmin/update_profile.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Profile updated successfully');
                        loadProfile();
                        closeProfileModal();
                    } else {
                        showToast(data.message || 'Failed to update profile');
                    }
                })
                .catch(() => showToast('Network error'));
            });

            // Avatar button event listeners
            document.getElementById('avatarOpen').addEventListener('click', openProfileModal);
            document.getElementById('avatarRemove').addEventListener('click', removeProfile);
            async function logout(){ const ok = await openConfirm('Are you sure you want to logout?', 'Logout'); if (!ok) return; fetch('../../php/superadmin/logout.php', { method:'POST' }).then(r=>r.json()).then(d=>{ if(d.success){ showToast('Logged out'); setTimeout(()=>{ window.location.href='super_admin_login.html'; }, 600); } else { showToast(d.message||'Logout failed'); } }).catch(()=>{ showToast('Network error'); setTimeout(()=>{ window.location.href='super_admin_login.html'; }, 800); }); }
            window.logout = logout;

            const deptBody = document.getElementById('deptBody');
            const modal = document.getElementById('deptModal');
            const openBtn = document.getElementById('openAddDept');
            const cancelBtn = document.getElementById('cancelDept');
            const form = document.getElementById('deptForm');
            const titleEl = document.getElementById('deptModalTitle');
            const inputEl = document.getElementById('deptInput');
            const formMsg = document.getElementById('deptFormMsg');

            function loadDepartments(){
                fetch('../../php/superadmin/departments_list.php')
                    .then(r=>r.json())
                    .then(data=>{
                        const rows = (data.departments||[]).map(d=>{
                            const name = String(d.department_name);
                            return `<tr>
                                <td style="padding:8px;">${name.replace(/</g,'&lt;')}</td>
                                <td style="padding:8px; display:flex; gap:8px;">
                                    <button class="editBtn" data-name="${name.replace(/"/g,'&quot;')}" style="background:#ffd60a;color:#800000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Edit</button>
                                    <button class="deleteBtn" data-name="${name.replace(/"/g,'&quot;')}" style="background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Delete</button>
                                </td>
                            </tr>`;
                        }).join('');
                        deptBody.innerHTML = rows || '<tr><td colspan="2" style="padding:10px; color:#666;">No departments</td></tr>';
                        deptBody.querySelectorAll('.editBtn').forEach(btn=>{
                            btn.addEventListener('click', function(){
                                const name = this.getAttribute('data-name');
                                form.mode.value = 'rename';
                                titleEl.textContent = 'Rename Department';
                                inputEl.value = name;
                                inputEl.setAttribute('data-old', name);
                                formMsg.textContent = '';
                                modal.style.display = 'flex';
                            });
                        });
                        deptBody.querySelectorAll('.deleteBtn').forEach(btn=>{
                            btn.addEventListener('click', async function(){
                                const name = this.getAttribute('data-name');
                                const ok = await openConfirm('Delete department "'+name+'"?', 'Delete Department');
                                if (!ok) return;
                                const fd = new FormData(); fd.append('name', name);
                                fetch('../../php/superadmin/departments_delete.php', { method:'POST', body: fd })
                                    .then(r=>r.json())
                                    .then(res=>{ if(res.success){ showToast('Department deleted'); loadDepartments(); } else { showToast(res.message||'Delete failed'); } })
                                    .catch(()=>showToast('Network error'));
                            });
                        });
                    })
                    .catch(()=>{ deptBody.innerHTML = '<tr><td colspan="2" style="padding:10px; color:#800000;">Network error</td></tr>'; });
            }

            document.addEventListener('DOMContentLoaded', function(){
                checkLogin().then(() => {
                    loadDepartments();
                    // Set fallback avatar immediately
                    const avatarElement = document.getElementById('avatarCircle');
                    const usernameElement = document.getElementById('username');
                    if (avatarElement && usernameElement) {
                        const username = usernameElement.textContent || 'Super Admin';
                        const firstLetter = username.charAt(0).toUpperCase();
                        avatarElement.textContent = firstLetter;
                        avatarElement.style.backgroundImage = 'none';
                    }
                    // Load profile after a short delay
                    setTimeout(loadProfile, 100);
                    // Load student count badge
                    fetch('../../php/superadmin/get_student_count.php').then(r=>r.json()).then(d=>{ const b=document.getElementById('badgeStudents'); if(b && d && d.success){ b.textContent = String(d.students||0); }}).catch(()=>{});
                });
                openBtn.addEventListener('click', ()=>{
                    form.mode.value = 'add';
                    titleEl.textContent = 'Add Department';
                    inputEl.value = '';
                    inputEl.removeAttribute('data-old');
                    formMsg.textContent='';
                    modal.style.display='flex';
                });
                cancelBtn.addEventListener('click', ()=>{ modal.style.display='none'; });
                modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; }});
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    const name = (inputEl.value||'').trim();
                    if (!name){ formMsg.style.color='#800000'; formMsg.textContent='Enter department name'; return; }
                    const mode = form.mode.value;
                    if (mode === 'add'){
                        const fd = new FormData(); fd.append('name', name);
                        fetch('../../php/superadmin/departments_add.php', { method:'POST', body: fd })
                            .then(r=>r.json()).then(res=>{ if(res.success){ modal.style.display='none'; loadDepartments(); showToast('Department added successfully'); } else { formMsg.style.color='#800000'; formMsg.textContent=res.message||'Add failed'; showToast(res.message||'Failed to add department'); } })
                            .catch(()=>{ formMsg.style.color='#800000'; formMsg.textContent='Network error'; showToast('Network error'); });
                    } else {
                        const oldName = inputEl.getAttribute('data-old') || '';
                        const fd = new FormData(); fd.append('old_name', oldName); fd.append('new_name', name);
                        fetch('../../php/superadmin/departments_update.php', { method:'POST', body: fd })
                            .then(r=>r.json()).then(res=>{ if(res.success){ modal.style.display='none'; loadDepartments(); showToast('Department renamed successfully'); } else { formMsg.style.color='#800000'; formMsg.textContent=res.message||'Rename failed'; showToast(res.message||'Failed to rename department'); } })
                            .catch(()=>{ formMsg.style.color='#800000'; formMsg.textContent='Network error'; showToast('Network error'); });
                    }
                });
            });
        })();
    </script>
</body>
</html>


