let previousActiveIds=new Set();
function showToastBadge(username,role){const c=document.getElementById('toastContainer');const el=document.createElement('div');el.className='toast';el.innerHTML=`<span class="badge">NEW</span> <span>${username} • ${role} is now active</span>`;c.appendChild(el);setTimeout(()=>{el.remove();},4000);} 
function checkLoginStatus(){fetch('../../php/superadmin/check_session.php').then(r=>r.json()).then(data=>{if(!data.logged_in){window.location.href='super_admin_login.html';}else{document.getElementById('username').textContent=data.username;const av=document.getElementById('avatarCircle');if(av){const initial=(data.username||'S').toString().trim().charAt(0).toUpperCase();av.textContent=initial||'S';fetch('../../php/superadmin/super_admin_profile_get.php').then(r=>r.json()).then(p=>{const url=p&&p.profile?(p.profile.avatar_url||''):'';if(url){av.textContent='';av.style.backgroundImage='url('+url+')';}}).catch(()=>{});}}}).catch(()=>{window.location.href='super_admin_login.html';});}
function openConfirm(message,title='Please Confirm'){return new Promise(resolve=>{const cm=document.getElementById('confirmModal');const msg=document.getElementById('confirmMessage');const ttl=document.getElementById('confirmTitle');const ok=document.getElementById('confirmOk');const cancel=document.getElementById('confirmCancel');ttl.textContent=title;msg.textContent=message;function cleanup(r){cm.style.display='none';ok.removeEventListener('click',okH);cancel.removeEventListener('click',cancelH);cm.removeEventListener('click',backdropH);resolve(r);}function okH(){cleanup(true);}function cancelH(){cleanup(false);}function backdropH(e){if(e.target===cm)cleanup(false);}ok.addEventListener('click',okH);cancel.addEventListener('click',cancelH);cm.addEventListener('click',backdropH);cm.style.display='flex';});}
function showToast(text){const c=document.getElementById('toastContainer');const el=document.createElement('div');el.className='toast';el.textContent=text;c.appendChild(el);setTimeout(()=>{el.remove();},2500);} 
async function logout(){const ok=await openConfirm('Are you sure you want to logout?','Logout');if(!ok)return;fetch('../../php/superadmin/logout.php',{method:'POST'}).then(r=>r.json()).then(d=>{if(d.success){showToast('Logged out');setTimeout(()=>{window.location.href='super_admin_login.html';},600);}else{showToast(d.message||'Logout failed');}}).catch(()=>{showToast('Network error');setTimeout(()=>{window.location.href='super_admin_login.html';},800);});}
function loadDashboardData(){fetch('../../php/superadmin/get_user_counts.php').then(r=>r.json()).then(data=>{if(data&&data.success){document.getElementById('totalAdmins').textContent=String(data.admins??0);document.getElementById('totalStaff').textContent=String(data.staff??0);document.getElementById('totalUsers').textContent=String(data.total??0);const bu=document.getElementById('badgeTotalUsers');if(bu)bu.textContent=String(data.total??0);const bd=document.getElementById('badgeTotalDepartments');if(bd)bd.textContent=String(data.departments??0);const dc=document.getElementById('totalDepartmentsCard');if(dc)dc.textContent=String(data.departments??0);}}).catch(()=>{});
fetch('../../php/superadmin/get_equipment_count.php').then(r=>r.json()).then(data=>{if(data&&data.success){document.getElementById('totalEquipment').textContent=String(data.equipment??0);const b=document.getElementById('badgeTotalEquipment');if(b)b.textContent=String(data.equipment??0);}}).catch(()=>{});
fetch('../../php/superadmin/get_student_count.php').then(r=>r.json()).then(data=>{if(data&&data.success){const b=document.getElementById('badgeTotalStudents');if(b)b.textContent=String(data.students??0);const t=document.getElementById('totalStudents');if(t)t.textContent=String(data.students??0);}}).catch(()=>{});
fetch('../../php/superadmin/departments_list.php').then(r=>r.json()).then(data=>{const total=(data&&data.success)?(data.count??(Array.isArray(data.departments)?data.departments.length:0)):0;const bd=document.getElementById('badgeTotalDepartments');if(bd)bd.textContent=String(total);const dc=document.getElementById('totalDepartmentsCard');if(dc)dc.textContent=String(total);}).catch(()=>{});
const activeEl=document.getElementById('activeSessions');if(activeEl)activeEl.textContent='—';
fetch('../../php/superadmin/get_activity.php').then(r=>r.json()).then(data=>{if(data&&data.success){document.getElementById('activeSessions').textContent=String(data.active?.total??'—');const users=(data.active&&Array.isArray(data.active.users))?data.active.users:[];const currentIds=new Set(users.map(u=>String(u.user_id)));users.forEach(u=>{const id=String(u.user_id);if(!previousActiveIds.has(id)){showToastBadge(u.username||'user',u.role||'');}});previousActiveIds=currentIds;const list=document.getElementById('activityList');if(Array.isArray(data.recent)&&list){list.innerHTML=data.recent.length===0?'<li><span class="meta">No recent activity</span></li>':data.recent.map(rec=>{const details=(()=>{try{return JSON.parse(rec.details||'{}')}catch{return{}}})();const actor=rec.actor_type==='user'?(details.username||`User #${rec.actor_id}`):(details.username||`Super Admin #${rec.actor_id}`);const actionText=(()=>{if(rec.action==='login')return `${actor} has logged in`;if(rec.action==='logout')return `${actor} has logged out`;if(rec.action==='create_user')return `${actor} created a ${details.role||'user'}: ${details.username||''}`;return `${actor} performed ${rec.action}`;})();const ts=rec.created_at?new Date(rec.created_at):null;const when=ts?ts.toLocaleString():'';return `<li><span class="dot"></span><div><div class="text">${actionText}</div><div class="meta">${when}</div></div></li>`;}).join('');}}}).catch(()=>{});} 

document.addEventListener('DOMContentLoaded',function(){checkLoginStatus();loadDashboardData();setInterval(loadDashboardData,20000);const addUserForm=document.getElementById('addUserForm');const messageEl=document.getElementById('addUserMessage');if(addUserForm){addUserForm.addEventListener('submit',function(e){e.preventDefault();messageEl.textContent='';const fd=new FormData(addUserForm);const password=fd.get('password')?.toString()||'';if(password.length<6){messageEl.style.color='#800000';messageEl.textContent='Password must be at least 6 characters';return;}fetch('../../php/superadmin/add_user.php',{method:'POST',body:fd}).then(r=>r.text()).then(t=>{try{const data=JSON.parse(t);if(data.success){messageEl.style.color='green';messageEl.textContent='User added successfully';addUserForm.reset();}else{messageEl.style.color='#800000';messageEl.textContent=(data.message||'Failed to add user')+(data.status?` (status ${data.status})`:'')+(data.detail?`: ${data.detail}`:'');}}catch{messageEl.style.color='#800000';messageEl.textContent='Server error. Please try again.';}}).catch(()=>{messageEl.style.color='#800000';messageEl.textContent='Network error. Please try again.';});});}
const profileModal=document.getElementById('profileModal');const pmUsername=document.getElementById('pmUsername');const pmEmail=document.getElementById('pmEmail');const pmAvatar=document.getElementById('profileAvatar');const pmUploadBtn=document.getElementById('pmUpload');const pmRemoveBtn=document.getElementById('pmRemove');const pmUploadForm=document.getElementById('pmUploadForm');const pmMsg=document.getElementById('pmMsg');const pmClose=document.getElementById('pmClose');const avatarCircle=document.getElementById('avatarCircle');const avatarOpen=document.getElementById('avatarOpen');const avatarRemove=document.getElementById('avatarRemove');function openProfileModal(){pmMsg.textContent='';fetch('../../php/superadmin/super_admin_profile_get.php').then(r=>r.json()).then(p=>{const prof=p&&p.profile?p.profile:{};pmUsername.textContent=prof.username||'—';pmEmail.textContent=prof.email||'—';const url=prof.avatar_url||'';pmAvatar.style.backgroundImage=url?('url('+url+')'):'';}).catch(()=>{});profileModal.style.display='flex';}
if(avatarOpen)avatarOpen.addEventListener('click',openProfileModal);if(avatarCircle)avatarCircle.addEventListener('click',openProfileModal);if(avatarRemove){avatarRemove.addEventListener('click',async function(){const ok=await openConfirm('Remove profile photo?','Remove Photo');if(!ok)return;fetch('../../php/superadmin/super_admin_avatar_delete.php',{method:'POST'}).then(r=>r.json()).then(res=>{if(res.success){avatarCircle.style.backgroundImage='';fetch('../../php/superadmin/check_session.php').then(r=>r.json()).then(d=>{const initial=(d.username||'S').toString().trim().charAt(0).toUpperCase();avatarCircle.textContent=initial||'S';pmAvatar.style.backgroundImage='';}).catch(()=>{avatarCircle.textContent='S';});showToast('Photo removed');}else{showToast(res.message||'Remove failed');}}).catch(()=>showToast('Network error'));});}
pmClose.addEventListener('click',()=>{profileModal.style.display='none';});profileModal.addEventListener('click',(e)=>{if(e.target===profileModal){profileModal.style.display='none';}});pmUploadBtn.addEventListener('click',()=>{pmUploadForm.querySelector('input[type="file"]').click();});pmUploadForm.addEventListener('change',function(){pmMsg.textContent='';const fd=new FormData(pmUploadForm);fetch('../../php/superadmin/super_admin_avatar_upload.php',{method:'POST',body:fd}).then(r=>r.json()).then(res=>{if(res.success){pmAvatar.style.backgroundImage='url('+res.avatar_url+')';avatarCircle.textContent='';avatarCircle.style.backgroundImage='url('+res.avatar_url+')';pmUploadForm.reset();pmMsg.style.color='green';pmMsg.textContent='Updated';}else{pmMsg.style.color='#800000';pmMsg.textContent=res.message||'Upload failed';}}).catch(()=>{pmMsg.style.color='#800000';pmMsg.textContent='Network error';});});
});
