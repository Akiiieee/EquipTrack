(function(){
function openConfirm(message,title='Please Confirm'){return new Promise(resolve=>{const cm=document.getElementById('confirmModal');const msg=document.getElementById('confirmMessage');const ttl=document.getElementById('confirmTitle');const ok=document.getElementById('confirmOk');const cancel=document.getElementById('confirmCancel');ttl.textContent=title;msg.textContent=message;function cleanup(result){cm.style.display='none';ok.removeEventListener('click',okH);cancel.removeEventListener('click',cancelH);cm.removeEventListener('click',backdropH);resolve(result);}function okH(){cleanup(true);}function cancelH(){cleanup(false);}function backdropH(e){if(e.target===cm)cleanup(false);}ok.addEventListener('click',okH);cancel.addEventListener('click',cancelH);cm.addEventListener('click',backdropH);cm.style.display='flex';});}
function showToast(text){const c=document.getElementById('toastContainer');const el=document.createElement('div');el.style.background='#800000';el.style.color='#fff';el.style.padding='10px 14px';el.style.borderRadius='8px';el.style.boxShadow='0 6px 16px rgba(0,0,0,.2)';el.textContent=text;c.appendChild(el);setTimeout(()=>{el.remove();},2500);} 
function checkLogin(){return fetch('../../php/superadmin/check_session.php').then(r=>r.json()).then(d=>{if(!d.logged_in){window.location.href='super_admin_login.html';}else{document.getElementById('username').textContent=d.username||'Super Admin';}});} 
async function logout(){const ok=await openConfirm('Are you sure you want to logout?','Logout');if(!ok)return;fetch('../../php/superadmin/logout.php',{method:'POST'}).then(r=>r.json()).then(d=>{if(d.success){showToast('Logged out');setTimeout(()=>{window.location.href='super_admin_login.html';},600);}else{showToast(d.message||'Logout failed');}}).catch(()=>{showToast('Network error');setTimeout(()=>{window.location.href='super_admin_login.html';},800);});}
window.logout=logout;
let openEditModal; let allUsers=[];
function renderUsers(rows){const body=document.getElementById('usersBody');const safe=s=>String(s||'').replace(/</g,'&lt;');const rowsHtml=(rows||[]).map(u=>`<tr data-user='${JSON.stringify({id:u.user_id,username:u.username,email:u.email,role:u.role,department:u.department}).replace(/'/g,"&apos;")}'><td style="padding:8px;">${safe(u.username)}</td><td style="padding:8px;">${safe(u.email)}</td><td style="padding:8px; text-transform:uppercase;">${safe(u.role)}</td><td style="padding:8px;">${safe(u.department)}</td><td style="padding:8px; display:flex; gap:8px;"><button data-id="${u.user_id}" class="editBtn" style="background:#ffd60a;color:#800000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Edit</button><button data-id="${u.user_id}" class="deleteBtn" style="background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Delete</button></td></tr>`).join('');body.innerHTML=rowsHtml||'<tr><td colspan="5" style="padding:10px; color:#666;">No users</td></tr>';body.querySelectorAll('.editBtn').forEach(btn=>{btn.addEventListener('click',function(){const tr=this.closest('tr');const info=JSON.parse(tr.getAttribute('data-user').replace(/&apos;/g,"'"));openEditModal(info);});});body.querySelectorAll('.deleteBtn').forEach(btn=>{btn.addEventListener('click',async function(){const id=this.getAttribute('data-id');const ok=await openConfirm('Delete this user?','Delete User');if(!ok)return;const fd=new FormData();fd.append('user_id',id);fetch('../../php/superadmin/user_delete.php',{method:'POST',body:fd}).then(r=>r.json()).then(res=>{if(res.success){showToast('User deleted');loadUsers();}else{showToast(res.message||'Delete failed');}}).catch(()=>showToast('Network error'));});});}
function loadUsers(){const body=document.getElementById('usersBody');fetch('../../php/superadmin/users_list.php').then(r=>r.json()).then(data=>{if(!data.success){body.innerHTML='<tr><td colspan="5" style="padding:10px; color:#800000;">Failed to load users</td></tr>';return;}allUsers=data.users||[];renderUsers(allUsers);}).catch(()=>{body.innerHTML='<tr><td colspan="5" style="padding:10px; color:#800000;">Network error</td></tr>';});}
function loadProfile(){const avatarElement=document.getElementById('avatarCircle');fetch('../../php/superadmin/get_profile.php').then(r=>r.json()).then(data=>{if(data.success&&data.profile_image){avatarElement.style.backgroundImage=`url('../../uploads/avatars/${data.profile_image}')`;avatarElement.style.backgroundSize='cover';avatarElement.style.backgroundPosition='center';}else{const username=(document.getElementById('username').textContent||'S').trim();avatarElement.textContent=username.charAt(0).toUpperCase();avatarElement.style.backgroundImage='none';}}).catch(()=>{const username=(document.getElementById('username').textContent||'S').trim();avatarElement.textContent=username.charAt(0).toUpperCase();});}

document.addEventListener('DOMContentLoaded',function(){checkLogin().then(()=>{loadUsers();const avatarElement=document.getElementById('avatarCircle');const usernameElement=document.getElementById('username');if(avatarElement&&usernameElement){const username=usernameElement.textContent||'Super Admin';const firstLetter=username.charAt(0).toUpperCase();avatarElement.textContent=firstLetter;avatarElement.style.backgroundImage='none';}setTimeout(loadProfile,100);fetch('../../php/superadmin/get_student_count.php').then(r=>r.json()).then(d=>{const b=document.getElementById('badgeStudents');if(b&&d&&d.success){b.textContent=String(d.students||0);}}).catch(()=>{});fetch('../../php/superadmin/departments_list.php').then(r=>r.json()).then(d=>{const sel=document.getElementById('userDeptFilter');const opts=(d.departments||[]).map(x=>`<option value="${String(x.department_name).replace(/"/g,'&quot;')}">${x.department_name}</option>`).join('');sel.insertAdjacentHTML('beforeend',opts);}).catch(()=>{});});
const userSearch=document.getElementById('userSearch');const userDeptFilter=document.getElementById('userDeptFilter');function applyUserFilters(){const q=(userSearch.value||'').toLowerCase().trim();const dept=userDeptFilter.value;const filtered=(allUsers||[]).filter(u=>{if(dept&&String(u.department||'')!==dept)return false;if(!q)return true;const parts=[u.username,u.email,u.role,u.department].map(v=>String(v||'').toLowerCase());return parts.some(p=>p.includes(q));});renderUsers(filtered);} userSearch.addEventListener('input',applyUserFilters);userDeptFilter.addEventListener('change',applyUserFilters);
const modal=document.getElementById('addUserModal');const openBtn=document.getElementById('openAddUser');const cancelBtn=document.getElementById('cancelAddUser');const form=document.getElementById('addUserForm');const msg=document.getElementById('addUserMessage');function populateDepartments(){const sel=document.getElementById('addUserDepartment');sel.innerHTML='<option value="" disabled selected>Loading…</option>';return fetch('../../php/superadmin/departments_list.php').then(r=>r.json()).then(data=>{const options=(data.departments||[]).map(d=>`<option value="${String(d.department_name).replace(/"/g,'&quot;')}">${d.department_name}</option>`).join('');sel.innerHTML=options||'<option value="" disabled selected>No departments</option>';}).catch(()=>{sel.innerHTML='<option value="" disabled selected>Failed to load</option>';});}
openBtn.addEventListener('click',()=>{msg.textContent='';populateDepartments().then(()=>{modal.style.display='flex';});});cancelBtn.addEventListener('click',()=>{modal.style.display='none';form.reset();});modal.addEventListener('click',(e)=>{if(e.target===modal){modal.style.display='none';}});form.addEventListener('submit',function(e){e.preventDefault();msg.textContent='';const fd=new FormData(form);const pwd=(fd.get('password')||'').toString();if(pwd.length<6){msg.style.color='#800000';msg.textContent='Password must be at least 6 characters';return;}fetch('../../php/superadmin/add_user.php',{method:'POST',body:fd}).then(r=>r.text()).then(t=>{try{const data=JSON.parse(t);if(data.success){msg.style.color='green';msg.textContent='User added';form.reset();modal.style.display='none';loadUsers();showToast('User added successfully');}else{msg.style.color='#800000';msg.textContent=data.message||'Failed to add user';showToast(data.message||'Failed to add user');}}catch{msg.style.color='#800000';msg.textContent='Server error';showToast('Server error');}}).catch(()=>{msg.style.color='#800000';msg.textContent='Network error';showToast('Network error');});});
const editModal=document.createElement('div');editModal.id='editUserModal';editModal.style.cssText='position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center;';editModal.innerHTML=`<div class="form-card" style="width:100%; max-width:520px;"><h3 style="color:#800000; margin-bottom:12px;">Edit User</h3><form id="editUserForm"><input type="hidden" name="user_id" /><div style="display:grid; gap:12px;"><div><label>Email</label><input type="email" name="email" required></div><div><label>Role</label><select name="role" required><option value="admin">Admin</option><option value="staff">Staff</option></select></div><div><label>Department</label><select name="department" id="editUserDepartment" required><option value="" disabled selected>Loading…</option></select></div><div class="message" id="editUserMessage"></div><div style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px;"><button type="button" id="cancelEditUser" class="submit-btn" style="background:#6c757d;">Cancel</button><button type="submit" class="submit-btn">Save</button></div></div></form></div>`;document.body.appendChild(editModal);
function populateEditDepartments(selected){const sel=document.getElementById('editUserDepartment');sel.innerHTML='<option value="" disabled selected>Loading…</option>';return fetch('../../php/superadmin/departments_list.php').then(r=>r.json()).then(data=>{const options=(data.departments||[]).map(d=>`<option value="${String(d.department_name).replace(/"/g,'&quot;')}">${d.department_name}</option>`).join('');sel.innerHTML=options||'<option value="" disabled selected>No departments</option>';if(selected)sel.value=selected;}).catch(()=>{sel.innerHTML='<option value="" disabled selected>Failed to load</option>';});}
openEditModal=function(info){const ef=document.getElementById('editUserForm');const emsg=document.getElementById('editUserMessage');ef.user_id.value=info.id;ef.email.value=info.email||'';ef.role.value=(info.role||'').toLowerCase()==='admin'?'admin':'staff';populateEditDepartments(info.department).then(()=>{editModal.style.display='flex';});emsg.textContent='';}
document.getElementById('cancelEditUser').addEventListener('click',()=>{editModal.style.display='none';});editModal.addEventListener('click',(e)=>{if(e.target===editModal){editModal.style.display='none';}});document.getElementById('editUserForm').addEventListener('submit',function(e){e.preventDefault();const emsg=document.getElementById('editUserMessage');emsg.textContent='';const fd=new FormData(this);fetch('../../php/superadmin/user_update.php',{method:'POST',body:fd}).then(r=>r.json()).then(res=>{if(res.success){editModal.style.display='none';loadUsers();showToast('User updated successfully');}else{emsg.style.color='#800000';emsg.textContent=res.message||'Update failed';showToast(res.message||'Update failed');}}).catch(()=>{emsg.style.color='#800000';emsg.textContent='Network error';showToast('Network error');});});
})();
