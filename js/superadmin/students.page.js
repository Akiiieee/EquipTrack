(function(){
function openConfirm(message,title='Please Confirm'){return new Promise(resolve=>{const cm=document.getElementById('confirmModal');const msg=document.getElementById('confirmMessage');const ttl=document.getElementById('confirmTitle');const ok=document.getElementById('confirmOk');const cancel=document.getElementById('confirmCancel');ttl.textContent=title;msg.textContent=message;function cleanup(result){cm.style.display='none';ok.removeEventListener('click',okH);cancel.removeEventListener('click',cancelH);cm.removeEventListener('click',backdropH);resolve(result);}function okH(){cleanup(true);}function cancelH(){cleanup(false);}function backdropH(e){if(e.target===cm)cleanup(false);}ok.addEventListener('click',okH);cancel.addEventListener('click',cancelH);cm.addEventListener('click',backdropH);cm.style.display='flex';});}
function showToast(text){const c=document.getElementById('toastContainer');const el=document.createElement('div');el.style.background='#800000';el.style.color='#fff';el.style.padding='10px 14px';el.style.borderRadius='8px';el.style.boxShadow='0 6px 16px rgba(0,0,0,.2)';el.textContent=text;c.appendChild(el);setTimeout(()=>{el.remove();},2500);} 
function checkLogin(){return fetch('../../php/superadmin/check_session.php').then(r=>r.json()).then(d=>{if(!d.logged_in){window.location.href='super_admin_login.html';}else{document.getElementById('username').textContent=d.username||'Super Admin';}});} 
async function logout(){const ok=await openConfirm('Are you sure you want to logout?','Logout');if(!ok)return;fetch('../../php/superadmin/logout.php',{method:'POST'}).then(r=>r.json()).then(d=>{if(d.success){showToast('Logged out');setTimeout(()=>{window.location.href='super_admin_login.html';},600);}else{showToast(d.message||'Logout failed');}}).catch(()=>{showToast('Network error');setTimeout(()=>{window.location.href='super_admin_login.html';},800);});}
window.logout=logout;
function loadProfile(){const avatarElement=document.getElementById('avatarCircle');fetch('../../php/superadmin/get_profile.php').then(r=>r.json()).then(data=>{if(data.success&&data.profile_image){avatarElement.style.backgroundImage=`url('../../uploads/avatars/${data.profile_image}')`;avatarElement.style.backgroundSize='cover';avatarElement.style.backgroundPosition='center';}else{const username=(document.getElementById('username').textContent||'S').trim();avatarElement.textContent=username.charAt(0).toUpperCase();avatarElement.style.backgroundImage='none';}}).catch(()=>{const username=(document.getElementById('username').textContent||'S').trim();avatarElement.textContent=username.charAt(0).toUpperCase();});}
function renderStudents(rows){const body=document.getElementById('studentsBody');const safe=s=>String(s??'').replace(/</g,'&lt;');body.innerHTML=(rows||[]).map(s=>{const isRegistered=String(s.status||'').toLowerCase()==='registered';return `<tr data-id="${s.id}"><td style="padding:8px;">${safe(s.stud_id)}</td><td style="padding:8px;">${safe(s.stud_name)}</td><td style="padding:8px;">${safe(s.email||'—')}</td><td style="padding:8px;">${safe(s.program)}</td><td style="padding:8px;">${safe(s.rfid||'—')}</td><td style="padding:8px;"><span class="status-badge ${isRegistered?'available':'reserved'}">${isRegistered?'Registered':'Not fully registered'}</span></td><td style="padding:8px;">${safe((s.created||'').toString().slice(0,19).replace('T',' '))}</td><td style="padding:8px; display:flex; gap:8px;"><button class="editBtn" data-id="${s.id}" style="background:#ffd60a;color:#800000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Edit</button>${isRegistered?'':`<button class="completeBtn" data-id="${s.id}" style="background:#ffd60a;color:#800000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Complete Registration</button>`}<button class="deleteBtn" data-id="${s.id}" style="background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Delete</button></td></tr>`;}).join('')||'<tr><td colspan="8" style="padding:10px; color:#666;">No students</td></tr>';body.querySelectorAll('.deleteBtn').forEach(btn=>{btn.addEventListener('click',async function(){const id=this.getAttribute('data-id');const ok=await openConfirm('Delete this student?','Delete Student');if(!ok)return;const fd=new FormData();fd.append('id',id);fetch('../../php/superadmin/students_delete.php',{method:'POST',body:fd}).then(r=>r.json()).then(res=>{if(res.success){showToast('Student deleted');loadStudents();}else{showToast(res.message||'Delete failed');}}).catch(()=>showToast('Network error'));});});body.querySelectorAll('.completeBtn').forEach(btn=>{btn.addEventListener('click',function(){openRfidModal(this.getAttribute('data-id'));});});body.querySelectorAll('.editBtn').forEach(btn=>{btn.addEventListener('click',function(){openEditModal(this.getAttribute('data-id'));});});}
let allStudents=[];function loadStudents(){const body=document.getElementById('studentsBody');fetch('../../php/superadmin/students_list.php').then(r=>r.json()).then(d=>{if(d.success){allStudents=d.data||[];renderStudents(allStudents);}else{body.innerHTML='<tr><td colspan="8" style="padding:10px; color:#800000;">Failed to load students</td></tr>';}}).catch(()=>{body.innerHTML='<tr><td colspan="8" style="padding:10px; color:#800000;">Network error</td></tr>';});}
const addModal=document.getElementById('addStudentModal');const addBtn=document.getElementById('openAddStudent');const addCancel=document.getElementById('cancelAddStudent');const addForm=document.getElementById('addStudentForm');const addMsg=document.getElementById('addStudentMessage');function populatePrograms(){const sel=document.getElementById('addStudentProgram');sel.innerHTML='<option value="" disabled selected>Loading…</option>';return fetch('../../php/superadmin/departments_list.php').then(r=>r.json()).then(data=>{const options=(data.departments||[]).map(d=>`<option value="${String(d.department_name).replace(/"/g,'&quot;')}">${d.department_name}</option>`).join('');sel.innerHTML=options||'<option value="" disabled selected>No departments</option>';}).catch(()=>{sel.innerHTML='<option value="" disabled selected>Failed to load</option>';});}
addBtn.addEventListener('click',()=>{addMsg.textContent='';populatePrograms().then(()=>{addModal.style.display='flex';});});addCancel.addEventListener('click',()=>{addModal.style.display='none';addForm.reset();});addModal.addEventListener('click',(e)=>{if(e.target===addModal){addModal.style.display='none';}});addForm.addEventListener('submit',function(e){e.preventDefault();addMsg.textContent='';const fd=new FormData(addForm);fetch('../../php/superadmin/students_add.php',{method:'POST',body:fd}).then(r=>r.json()).then(res=>{if(res.success){showToast('Student added');addForm.reset();addModal.style.display='none';loadStudents();}else{addMsg.style.color='#800000';addMsg.textContent=res.message||'Failed to add';showToast(res.message||'Failed to add');}}).catch(()=>{addMsg.style.color='#800000';addMsg.textContent='Network error';showToast('Network error');});});
const rfidModal=document.getElementById('rfidModal');const rfidCancel=document.getElementById('rfidCancel');const rfidForm=document.getElementById('rfidForm');const rfidInput=document.getElementById('rfidInput');const rfidMsg=document.getElementById('rfidMessage');window.openRfidModal=function(id){document.getElementById('rfidStudentId').value=id;rfidMsg.textContent='';rfidInput.value='';rfidModal.style.display='flex';setTimeout(()=>{rfidInput.focus();},50);} 
rfidCancel.addEventListener('click',()=>{rfidModal.style.display='none';});rfidModal.addEventListener('click',(e)=>{if(e.target===rfidModal){rfidModal.style.display='none';}});rfidInput.addEventListener('keypress',function(e){if(e.key==='Enter'){e.preventDefault();rfidForm.requestSubmit();}});rfidForm.addEventListener('submit',function(e){e.preventDefault();const fd=new FormData(rfidForm);const value=(fd.get('rfid')||'').toString().trim();if(value.length<4){rfidMsg.style.color='#800000';rfidMsg.textContent='Invalid RFID';return;}fetch('../../php/superadmin/students_update_status.php',{method:'POST',body:fd}).then(r=>r.json()).then(res=>{if(res.success){showToast('Registration completed');rfidModal.style.display='none';loadStudents();}else{rfidMsg.style.color='#800000';rfidMsg.textContent=res.message||'Update failed';showToast(res.message||'Update failed');}}).catch(()=>{rfidMsg.style.color='#800000';rfidMsg.textContent='Network error';showToast('Network error');});});
const editModal=document.getElementById('editStudentModal');const editCancel=document.getElementById('cancelEditStudent');const editForm=document.getElementById('editStudentForm');const editMsg=document.getElementById('editStudentMessage');function populateEditPrograms(selected){const sel=document.getElementById('editStudentProgram');if(!sel)return Promise.resolve();sel.innerHTML='<option value="" disabled selected>Loading…</option>';return fetch('../../php/superadmin/departments_list.php').then(r=>r.json()).then(data=>{const options=(data.departments||[]).map(d=>`<option value="${String(d.department_name).replace(/"/g,'&quot;')}">${d.department_name}</option>`).join('');sel.innerHTML=options||'<option value="" disabled selected>No departments</option>';if(selected)sel.value=selected;}).catch(()=>{sel.innerHTML='<option value="" disabled selected>Failed to load</option>';});}
function openEditModal(id){const s=(allStudents||[]).find(x=>String(x.id)===String(id));if(!s)return;editForm.id.value=s.id;editForm.stud_id.value=s.stud_id||'';editForm.stud_name.value=s.stud_name||'';populateEditPrograms(s.program).then(()=>{editModal.style.display='flex';});editMsg.textContent='';}
if(editCancel){editCancel.addEventListener('click',()=>{editModal.style.display='none';});}
if(editModal){editModal.addEventListener('click',(e)=>{if(e.target===editModal){editModal.style.display='none';}});} 
if(editForm){editForm.addEventListener('submit',function(e){e.preventDefault();editMsg.textContent='';const fd=new FormData(editForm);fetch('../../php/superadmin/students_update.php',{method:'POST',body:fd}).then(r=>r.json()).then(res=>{if(res.success){showToast('Student updated');editModal.style.display='none';loadStudents();}else{editMsg.style.color='#800000';editMsg.textContent=res.message||'Update failed';showToast(res.message||'Update failed');}}).catch(()=>{editMsg.style.color='#800000';editMsg.textContent='Network error';showToast('Network error');});});}
const searchInput=document.getElementById('studentSearch');if(searchInput){searchInput.addEventListener('input',function(){const q=this.value.toLowerCase().trim();if(!q){renderStudents(allStudents);return;}const filtered=(allStudents||[]).filter(s=>{const parts=[s.stud_id,s.stud_name,s.email,s.program,s.rfid,s.status].map(x=>String(x||'').toLowerCase());return parts.some(p=>p.includes(q));});renderStudents(filtered);});}

document.addEventListener('DOMContentLoaded',function(){checkLogin().then(()=>{const avatarElement=document.getElementById('avatarCircle');const usernameElement=document.getElementById('username');const firstLetter=(usernameElement.textContent||'S').trim().charAt(0).toUpperCase();avatarElement.textContent=firstLetter;loadProfile();loadStudents();fetch('../../php/superadmin/get_student_count.php').then(r=>r.json()).then(d=>{const b=document.getElementById('badgeStudents');if(b&&d&&d.success){b.textContent=String(d.students||0);}}).catch(()=>{});});document.getElementById('avatarOpen').addEventListener('click',()=>{document.getElementById('profileModal').style.display='block';loadProfile();});document.getElementById('avatarRemove').addEventListener('click',function(){openConfirm('Remove profile picture?','Remove Profile').then(confirmed=>{if(!confirmed)return;fetch('../../php/superadmin/remove_profile.php',{method:'POST'}).then(r=>r.json()).then(d=>{if(d.success){showToast('Profile picture removed');loadProfile();document.getElementById('profileModal').style.display='none';}else{showToast(d.message||'Failed to remove');}}).catch(()=>showToast('Network error'));});});document.getElementById('profileForm').addEventListener('submit',function(e){e.preventDefault();const fd=new FormData(this);fetch('../../php/superadmin/update_profile.php',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.success){showToast('Profile updated');loadProfile();document.getElementById('profileModal').style.display='none';}else{showToast(d.message||'Update failed');}}).catch(()=>showToast('Network error'));});});
})();
